"use strict";var app={apikeys:{vk:3992322,last:{apiKey:"e5b0685046dd1fdcf351e21ad6728ad2",apiSecret:"8e92d9f73e07eaece388a3aa74d35988"}},artists:[],playlist:[],vk:{},last:{sk:null},host:"last.vk"};
if(location.hostname==="skakruk.github.io"){app.apikeys.vk=3996225;app.host="skakruk.github.io/lastvk/app/";}var player;var isLastAuthorized=false;var isVKAuthorized=false;
var loginsModal;var currentIndex=-1;var cache=new LastFMCache();var curSong;var lastfm=new LastFM({apiKey:app.apikeys.last.apiKey,apiSecret:app.apikeys.last.apiSecret,cache:cache});
function pushtoScrobbler(b){if(!b.scrobbled){var a=Math.floor((new Date()).getTime()/1000);lastfm.track.scrobble([{artist:b.artist.name,track:b.name,timestamp:a}],{key:app.last.sk});
b.scrobbled=true;}}function getLastToken(){}function authInfo(a){if(a.session){VK.Api.call("users.get",{uids:a.session.mid},function(b){if(b.response){a.session=$.merge(a.session,b.response[0]);
}});isVKAuthorized=true;localStorage.setItem("vk",JSON.stringify(a.session));app.vk=a.session;$("#vk-login").prop("disabled",true);if(isLastAuthorized){loginsModal.modal("hide");
}}else{$("#vk-login").prop("disabled",false);loginsModal.modal("show");}}function initApis(){if(app.last.sk&&app.last.sk.length>0){isLastAuthorized=true;
$("#search").prop("disabled",false);$("#last-login").prop("disabled",true);if(isVKAuthorized){loginsModal.modal("hide");}}else{$("#last-login").prop("disabled",false);
loginsModal.modal("show");}VK.Auth.getLoginStatus(authInfo);}function sidebarHeight(){var a=+$(window).height()-70;$("#sidebar").css("height",a);}$(document).ready(function(){loginsModal=$("#loginsModal").modal({backdrop:"static"});
sidebarHeight();$(window).resize(function(){sidebarHeight();});player=$("#player").jPlayer({swfPath:"scripts/jplayer",supplied:"mp3",wmode:"window",smoothPlayBar:true,keyEnabled:true,volume:0.4,ended:function(){currentIndex++;
$("#playlist a:eq("+currentIndex+")").trigger("click");},timeupdate:function(d){if(d.jPlayer.status.currentTime>30){pushtoScrobbler(curSong);}},loadeddata:function(){curSong.scrobbled=false;
}});$(".jp-next").on("click",function(d){d.preventDefault();currentIndex++;$("#playlist a:eq("+currentIndex+")").trigger("click");});VK.init({apiId:app.apikeys.vk});
app.lfmToken=getParameterByName("token");app.last=localStorage.last?JSON.parse(localStorage.last):{};if(app.lfmToken.length>0){lastfm.auth.getSession({token:app.lfmToken},{success:function(d){app.last.sk=d.session.key;
localStorage.last=JSON.stringify({sk:d.session.key});initApis();},error:function(e,d){console.log(e,d);}});}initApis();$("#vk-login").on("click",function(d){d.preventDefault();
if(!$(this).is(":disabled")){VK.Auth.login(authInfo,VK.access.AUDIO);}});$("#last-login").on("click",function(d){d.preventDefault();if(!$(this).is(":disabled")){window.location="http://www.last.fm/api/auth/?api_key="+app.apikeys.last.apiKey+"&cb=http://"+app.host;
}});$("#search-form").on("submit",function(f){f.preventDefault();var d=$("#search-query").val();lastfm.user.getTopArtists({user:d},{success:function(e){app.artists=$.merge(app.artists,e.topartists.artist);
$("#playlist").trigger("artistsLoaded",[e.topartists.artist]);},error:function(g,e){console.log(g,e);}});$("#loading").addClass("in");});function b(d,e){var g=new $.Deferred();
var f={limit:10,autocorrect:1};if(d.mbid.length>0){$.extend(f,{mbid:d.mbid});}else{$.extend(f,{artist:d.name});}lastfm.artist.getTopTracks(f,{success:function(h){h.toptracks.track.artist=d;
app.playlist=$.merge(app.playlist,h.toptracks.track);e=$.merge(e,h.toptracks.track);g.resolve(e);},error:function(i,h){console.log(i,h);}});return g.promise();
}function a(d){var e=new $.Deferred();lastfm.artist.getSimilar({artist:d.name,limit:5},{success:function(f){app.artists=$.merge(app.artists,f.similarartists.artist);
e.resolve(app.artists);},error:function(g,f){console.log(g,f);}});return e.promise();}function c(d,e){var g=new $.Deferred();var f={_id:"497d65876d1d3fab8ea3d33f61b82a90",_render:"json",api_key:app.apikeys.last.apiKey,mbid:d.mbid,limitsongs:20};
return $.ajax({dataType:"json",url:"http://pipes.yahoo.com/pipes/pipe.run",data:f,success:function(h){$.each(h.value.items,function(i,j){if(j.songs!==null){app.playlist=$.merge(app.playlist,j.songs);
e=$.merge(e,j.songs);}});},jsonp:"_callback"});}$("#playlist").on("artistsLoaded",function(h,g){var f=[];var d=[];$.each(g,function(i,e){d.push(c(e,f));
});$.when.apply($,d).then(function(e){$("#playlist").trigger("playlistUpdated",[f]);});}).on("playlistUpdated",function(g,f){f=shuffleArray(f);var d=this;
$.each(f,function(e,i){var h=$('<a href="#" class="list-group-item">'+i.artist.name+" - "+i.name+"</a>");h.data("song",i);$(d).append(h);});$("#loading").removeClass("in");
currentIndex++;$("#playlist a:eq("+currentIndex+")").trigger("click");}).on("click","a",function(g){g.preventDefault();var d=$(this);$("#playlist a").removeClass("active");
d.addClass("active");currentIndex=$(this).index();curSong=d.data("song");var h=[];var f=curSong.artist.name+" - "+curSong.name;$("title").html(f);VK.Api.call("audio.search",{q:f,sort:2,count:10},function(j){if(j.error){if(j.error.error_code===7){VK.Auth.logout(function(){$("#vk-login").prop("disabled",false);
loginsModal.modal("show");});}return;}if(j.response){var e=j.response.splice(1);$.each(e,function(k,l){if(l.artist===curSong.artist.name&&l.title===curSong.name){h.push(l);
}});if(h.length===0){h=shuffleArray(e);}player.jPlayer("setMedia",{mp3:h[Math.floor(Math.random()*h.length)].url});player.jPlayer("load");player.jPlayer("play");
var i="images/no-cover.jpg";if(curSong.image){i=curSong.image[3]["_text"];}else{if(curSong.artist.image){i=curSong.image[3]["_text"];}}$("#song-img").attr("src",i);
$("#song-title").html("<h1>"+curSong.name+" <small>by "+curSong.artist.name+"</small></h1>");$("#song-info").show();lastfm.track.getInfo({mbid:curSong.mbid,artist:curSong.artist.name,track:curSong.name},{success:function(n){var k=n.track;
var l=[];if(k.album){$("#album-name").html(k.album.title).parent().show();}else{$("#album-name").parent().hide();}if(k.toptags.tag){for(var m in k.toptags.tag){l.push(k.toptags.tag[m].name);
}$("#track-genre").html(l.join(", ")).parent().show();}else{$("#track-genre").parent().hide();}},error:function(k,l){console.log(k,l);}});lastfm.artist.getInfo({mbid:curSong.artist.mbid,artist:curSong.artist.name},{success:function(l){var k=l.artist;
if(k.bio.content){$("#bio").html(k.bio.content.replace(/\n/g,"<br/>")).show();}else{$("#bio").hide();}},error:function(k,l){console.log(k,l);}});}});});
});